var Game=function(t,s,h,a){function r(t,i,s,e,h,n,a,r){this.x=i,this.y=s,this.sx=e,this.sy=h,this.s=a,this.frame=0,this.xtick=0,this.ytick=0,this.xs="number"!=typeof n[0]?n[0][0]:n[0],this.xe="number"!=typeof n[0]?n[0][1]-1:n[0]-1,this.ys="number"!=typeof n[1]?n[1][0]:n[1],this.ye="number"!=typeof n[1]?n[1][1]-1:n[1]-1,this.animTick=0;return this.update=function(t){this.animTick+=t,this.animTick>=250&&(this.frame++,this.frame>1&&(this.frame=0),this.animTick=0),r.call(this,t)},this.draw=function(){m.draw(this.s,this.x*t.ts,this.y*t.ts,this.frame)},this.destroy=function(){var i=t.objQ.indexOf(this);i>-1&&t.objQ.splice(i,1)},this}var c;document.addEventListener("click",function(t){c=t.target},!1);var u=this;this.objQ=[],this.levels={},this.iLoaded=!1,this.lLoaded=!1,this.tick=(new Date).getTime(),this.utick=(new Date).getTime(),this.ps=1,this.currLevel=0,this.levelObj;var f=30,d=this.ca=document.getElementById(t);this.ca.setAttribute("width",20*s),this.ca.setAttribute("height",20*h),this.tw=s,this.th=h,this.ts=20,this.w=parseInt(this.ca.getAttribute("width")),this.h=parseInt(this.ca.getAttribute("height"));var y=this.cx=d.getContext("2d");this.running=!0;var m=new function(){this.map={},this.load=function(t,i,s){this.map=i,this.image=new Image,this.image.onload=s,this.image.src=t},this.draw=function(t,i,s,e){var h=this.map[t];e=e?e:0,y.drawImage(this.image,h.sx+e*h.w,h.sy,h.w,h.h,i,s,h.w,h.h)}};this.update=function(){n=(new Date).getTime();var t=n-this.utick;for(o in this.objQ)this.objQ[o].update(t);this.utick=n},this.draw=function(){this.cx.clearRect(0,0,this.w,this.h),void 0!==this.levelObj&&this.currLevel>0?this.levelObj.draw():this.startScreen();for(o in this.objQ)this.objQ[o].draw()},this.startScreen=function(){},this.run=function(){if(this.running){var t=(new Date).getTime(),i=t-u.tick;u.update(),i>=1e3/f&&(u.draw(),u.tick=t)}else this.cx.font="48px verdana",this.cx.fillText("Game Over",50,50)},this.loadLevel=function(t){this.objQ=[],this.currLevel=t,this.levelObj=new x(this,this.levels[t],"tile")},this.lRes=function(){var t=new XMLHttpRequest;t.open("GET","resources.json"),t.onreadystatechange=function(){if(4==t.readyState){var i=JSON.parse(t.responseText),s=i.levels,e=i.sprites;m.load("spritesheet.png",e,function(){for(level in s){var t=s[level];u.levels[level]=t}u.lLoaded=!0,u.iLoaded=!0})}},t.send()};var l=function(t,i,s,h){this.x=i,this.y=s,this.s=h,this.frame=0,this.dx=0,this.dy=0,this.xTick=0,this.yTick=0,this.jetpack=!1;var n=this,a=function(i,s,e){if("map"==i){var h=Math.ceil(n.y)-1,a=Math.floor(n.x),r=Math.ceil(n.x),o=t.levelObj.getTile(a,h),c=t.levelObj.getTile(r,h);return 1==o||1==c?!0:!1}var u=Math.abs;return 2*u(s.x-e.x)<1&&2*u(s.y-e.y)<1};this.update=function(i){this.xTick+=i,this.yTick+=i,this.jetpack?this.dy=.25:this.y%1==0&&(a("map")?(this.dy=0,this.yTick=0):this.dy=-.25),this.xTick>=50&&(this.x+=this.dx,this.xTick=0),this.yTick>=50&&(this.y+=this.dy,this.yTick=0);var s=this.frame;this.dx>0?s=1:this.dx<0&&(s=0),!this.jetpack||1!=s&&0!=s?!this.jetpack&&s>1&&(s-=2):s+=2,this.frame=s;for(var i in t.objQ)if("Enemy"==t.objQ[i].constructor.name&&(e=t.objQ[i],a("enemy",this,e))){t.running=!1;break}},this.draw=function(){m.draw(this.s,this.x*t.ts,this.y*t.ts,this.frame)},this.fire=function(){var i=-1==[1,3].indexOf(this.frame)?-1:1,s=new v(t,this.x,this.y,i,"bullet");t.objQ.push(s)},document.addEventListener("keydown",function(i){if(c==t.ca){var s=i.keyCode;40==s?a("map")&&(n.jetpack=!0):37==s?n.dx=-.25:39==s?n.dx=.25:32==s&&n.fire()}}),document.addEventListener("keyup",function(i){if(c==t.ca){var s=i.keyCode;40==s?n.jetpack=!1:37==s?(n.dx=0,n.xTick=0):39==s&&(n.dx=0,n.xTick=0)}})},v=function(t,i,s,h,n){this.s=n,this.x=i,this.y=s,this.dir=h,this.animTick=0,this.destroy=function(){var i=t.objQ.indexOf(this);i>-1&&t.objQ.splice(i,1)};var a=function(t,i){var s=Math.abs;return 2*s(t.x-i.x)<1&&2*s(t.y-i.y)<1};return this.update=function(i){this.animTick+=i,this.animTick>=25&&(this.x+=h>0?.25:-.25,this.animTick=0);for(var i in t.objQ)if("Enemy"==t.objQ[i].constructor.name&&(e=t.objQ[i],a(this,e))){this.destroy(),e.destroy();break}(this.x>t.tw||this.x<0||this.y>t.th||this.y<0)&&this.destroy()},this.draw=function(){m.draw(this.s,this.x*t.ts,this.y*t.ts)},this},x=function(t,s,e){var h=[],n=e;return this.init=function(){var t=s.map,i=0;for(g in t){for(var e=t[g],n="number"!=typeof e[0]?e[0][0]:e[0],a="number"!=typeof e[0]?e[0][1]:e[0],o="number"!=typeof e[1]?e[1][0]:e[1],c="number"!=typeof e[1]?e[1][1]:e[1];i<o*u.tw+n;i++)h[i]=0;for(;i<c*u.tw+a;i++)h[i]=1}for(;i<u.tw*u.th;i++)h[i]=0;for(var f=s.npcs,d=0;d<f.length;d++){e=t[f[d][0]],n="number"!=typeof e[0]?e[0][0]:e[0],a="number"!=typeof e[0]?e[0][1]-1:e[0]-1,o="number"!=typeof e[1]?e[1][0]:e[1],c="number"!=typeof e[1]?e[1][1]-1:e[1]-1;var y=Math.floor(Math.random()*(a-n))+n,m=Math.floor(Math.random()*(c-o))+(o+2),v=.5*Math.random()+.5,x=f[d][1],p=new r(u,y,m,v,0,e,x,function(t){this.xtick+=t,this.ytick+=t,this.xtick/250>=Math.abs(this.sx)&&(this.x+=this.sx<0?-.25:0==this.sx?0:.25,this.xtick=0,(this.x==this.xe||this.x==this.xs)&&(this.sx*=-1)),this.ytick/250>=Math.abs(this.sy)&&(this.y+=this.sy<0?-.25:0==this.sy?0:.25,this.ytick=0,(this.y==this.ye||this.y==this.ys)&&(this.sy*=-1))});u.objQ.push(p)}var b=new l(u,10,6,"hero");u.objQ.push(b)},this.draw=function(){for(i in h)if(0!==h[i]){var s=i%t.tw,e=parseInt(i/t.tw);m.draw(n,s*t.ts,e*t.ts)}},this.getMap=function(){return h},this.getTile=function(i,s){var e=s*t.tw+i;return h[e]},this.init(),this};return this.init=function(){if(this.lRes(),0==u.iLoaded){var t=function(){0==u.iLoaded?setTimeout(t,300):(u.loadLevel(1),a.apply(u))};setTimeout(t,300)}},this.init(),this};